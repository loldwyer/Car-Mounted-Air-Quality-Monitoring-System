<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Car-Mounted Air Quality Dashboard</title>
</head>
<body>

  <h1>Car Portable Urban Air Quality Monitor</h1>
  <p>Live CO₂, PM2.5, NO₂ readings from ESP32 + Blynk + ThingSpeak</p>

  <h2>📊 Live Sensor Dashboard (Tabbed)</h2>

  <div class="tabs">
    <button class="tablink" onclick="showTab('co2', this)">CO₂</button>
    <button class="tablink" onclick="showTab('pm25', this)">PM2.5</button>
    <button class="tablink" onclick="showTab('pm10', this)">PM10</button>
    <button class="tablink" onclick="showTab('pm1', this)">PM1.0</button>
    <button class="tablink" onclick="showTab('temp', this)">Temp</button>
    <button class="tablink" onclick="showTab('rh', this)">Humidity</button>
    <button class="tablink" onclick="showTab('no2', this)">NO₂</button>
  </div>

  <div id="co2" class="tabcontent">
    <p><strong>Latest CO₂:</strong> <span id="co2val">Loading...</span> ppm</p>
    <iframe width="100%" height="350" src="https://thingspeak.com/channels/2960675/charts/4?dynamic=true" frameborder="0"></iframe>
  </div>

  <div id="pm25" class="tabcontent" style="display:none;">
    <p><strong>Latest PM2.5:</strong> <span id="pm25val">Loading...</span> µg/m³</p>
    <iframe width="100%" height="350" src="https://thingspeak.com/channels/2960675/charts/2?dynamic=true" frameborder="0"></iframe>
  </div>

  <div id="pm10" class="tabcontent" style="display:none;">
    <p><strong>Latest PM10:</strong> <span id="pm10val">Loading...</span> µg/m³</p>
    <iframe width="100%" height="350" src="https://thingspeak.com/channels/2960675/charts/3?dynamic=true" frameborder="0"></iframe>
  </div>

  <div id="pm1" class="tabcontent" style="display:none;">
    <p><strong>Latest PM1.0:</strong> <span id="pm1val">Loading...</span> µg/m³</p>
    <iframe width="100%" height="350" src="https://thingspeak.com/channels/2960675/charts/1?dynamic=true" frameborder="0"></iframe>
  </div>

  <div id="temp" class="tabcontent" style="display:none;">
    <p><strong>Latest Temp:</strong> <span id="tempval">Loading...</span> °C</p>
    <iframe width="100%" height="350" src="https://thingspeak.com/channels/2960675/charts/5?dynamic=true" frameborder="0"></iframe>
  </div>

  <div id="rh" class="tabcontent" style="display:none;">
    <p><strong>Latest Humidity:</strong> <span id="humval">Loading...</span> %</p>
    <iframe width="100%" height="350" src="https://thingspeak.com/channels/2960675/charts/6?dynamic=true" frameborder="0"></iframe>
  </div>

  <div id="no2" class="tabcontent" style="display:none;">
    <p><strong>Latest NO₂ Voltage:</strong> <span id="no2val">Loading...</span> V</p>
    <iframe width="100%" height="350" src="https://thingspeak.com/channels/2960675/charts/7?dynamic=true" frameborder="0"></iframe>
  </div>

  <script>
    function showTab(id, el) {
      const contents = document.querySelectorAll('.tabcontent');
      contents.forEach(el => el.style.display = 'none');
      document.getElementById(id).style.display = 'block';

      const buttons = document.querySelectorAll('.tablink');
      buttons.forEach(btn => btn.classList.remove('active'));
      if (el) el.classList.add('active');
    }

    async function fetchThingSpeakData() {
      try {
        console.log("📡 Fetching ThingSpeak data...");
        const response = await fetch('https://api.thingspeak.com/channels/2960675/feeds.json?results=1');
        const data = await response.json();

        if (data && data.feeds && data.feeds.length > 0) {
          const feed = data.feeds[0];
          document.getElementById('co2val').textContent = parseFloat(feed.field4).toFixed(1);
          document.getElementById('pm25val').textContent = parseFloat(feed.field2).toFixed(1);
          document.getElementById('pm10val').textContent = parseFloat(feed.field3).toFixed(1);
          document.getElementById('pm1val').textContent = parseFloat(feed.field1).toFixed(1);
          document.getElementById('tempval').textContent = parseFloat(feed.field5).toFixed(1);
          document.getElementById('humval').textContent = parseFloat(feed.field6).toFixed(1);
          document.getElementById('no2val').textContent = parseFloat(feed.field7).toFixed(3);
        } else {
          console.error("❌ No feed data found.");
        }
      } catch (err) {
        console.error("❌ Error fetching ThingSpeak data:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      showTab('co2', document.querySelector(".tablink"));
      fetchThingSpeakData();
      setInterval(fetchThingSpeakData, 30000); // Update every 30s
    });
  </script>

</body>
</html>
