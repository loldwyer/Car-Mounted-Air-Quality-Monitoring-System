<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Car-Mounted Air Quality Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Car Portable Urban Air Quality Monitor</h1>
    <p>Live COâ‚‚, PM, NOâ‚‚ readings from ESP32 + Blynk + ThingSpeak</p>
  </header>

  <section>
    <h2>ðŸ“Š Live Sensor Dashboard</h2>

    <label for="sensorSelect"><strong>View by Sensor:</strong></label>
    <select id="sensorSelect" onchange="handleSensorSelect(this.value)">
      <option value="none">-- Select --</option>
      <option value="scd30">SCD30 (COâ‚‚, Temp, RH)</option>
      <option value="sps30">SPS30 (PM1.0, PM2.5, PM10)</option>
      <option value="mics">MiCS-4514 (NOâ‚‚)</option>
    </select>

    <div class="tabs">
      <button class="tablink" onclick="showTab('co2', this)">COâ‚‚</button>
      <button class="tablink" onclick="showTab('pm25', this)">PM2.5</button>
      <button class="tablink" onclick="showTab('pm10', this)">PM10</button>
      <button class="tablink" onclick="showTab('pm1', this)">PM1.0</button>
      <button class="tablink" onclick="showTab('temp', this)">Temp</button>
      <button class="tablink" onclick="showTab('rh', this)">Humidity</button>
      <button class="tablink" onclick="showTab('no2', this)">NOâ‚‚</button>
    </div>

    <div id="co2" class="tabcontent">
      <p><strong>Latest COâ‚‚:</strong> <span id="co2val">Loading...</span> ppm</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/4?dynamic=true"></iframe>
    </div>

    <div id="pm25" class="tabcontent">
      <p><strong>Latest PM2.5:</strong> <span id="pm25val">Loading...</span> Âµg/mÂ³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/2?dynamic=true"></iframe>
    </div>

    <div id="pm10" class="tabcontent">
      <p><strong>Latest PM10:</strong> <span id="pm10val">Loading...</span> Âµg/mÂ³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/3?dynamic=true"></iframe>
    </div>

    <div id="pm1" class="tabcontent">
      <p><strong>Latest PM1.0:</strong> <span id="pm1val">Loading...</span> Âµg/mÂ³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/1?dynamic=true"></iframe>
    </div>

    <div id="temp" class="tabcontent">
      <p><strong>Latest Temp:</strong> <span id="tempval">Loading...</span> Â°C</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/5?dynamic=true"></iframe>
    </div>

    <div id="rh" class="tabcontent">
      <p><strong>Latest Humidity:</strong> <span id="humval">Loading...</span> %</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/6?dynamic=true"></iframe>
    </div>

    <div id="no2" class="tabcontent">
      <p><strong>Latest NOâ‚‚ Voltage:</strong> <span id="no2val">Loading...</span> V</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/7?dynamic=true"></iframe>
    </div>
  </section>

  <section>
    <h2>Hardware Overview</h2>
    <p>This system uses an ESP32 with the following sensors:</p>
    <ul>
      <li>SCD30: COâ‚‚, Temperature, Humidity</li>
      <li>SPS30: PM1.0, PM2.5, PM10</li>
      <li>MiCS-4514: NOâ‚‚</li>
      <li>DS3231 RTC for timestamps</li>
      <li>SD card for local logging</li>
      <li>Blynk + ThingSpeak for remote access</li>
    </ul>
  </section>

  <footer>
    <p>&copy; 2025 Lauren Dwyer | MEng ECE</p>
  </footer>

  <script>
    const tabGroups = {
      scd30: ['co2', 'temp', 'rh'],
      sps30: ['pm1', 'pm25', 'pm10'],
      mics: ['no2']
    };

    function showTab(id, el) {
      hideAllTabs();
      document.getElementById(id).style.display = 'block';

      document.querySelectorAll('.tablink').forEach(btn => btn.classList.remove('active'));
      if (el) el.classList.add('active');

      document.getElementById('sensorSelect').value = 'none';
    }

    function handleSensorSelect(sensor) {
      hideAllTabs();
      if (sensor in tabGroups) {
        tabGroups[sensor].forEach(id => {
          document.getElementById(id).style.display = 'block';
        });
        document.querySelectorAll('.tablink').forEach(btn => btn.classList.remove('active'));
      }
    }

    function hideAllTabs() {
      document.querySelectorAll('.tabcontent').forEach(el => el.style.display = 'none');
    }

    async function fetchThingSpeakData() {
      try {
        const response = await fetch('https://api.thingspeak.com/channels/2960675/feeds.json?results=1');
        const data = await response.json();
        if (data && data.feeds.length > 0) {
          const feed = data.feeds[0];
          document.getElementById('co2val').textContent = parseFloat(feed.field4).toFixed(1);
          document.getElementById('pm25val').textContent = parseFloat(feed.field2).toFixed(1);
          document.getElementById('pm10val').textContent = parseFloat(feed.field3).toFixed(1);
          document.getElementById('pm1val').textContent = parseFloat(feed.field1).toFixed(1);
          document.getElementById('tempval').textContent = parseFloat(feed.field5).toFixed(1);
          document.getElementById('humval').textContent = parseFloat(feed.field6).toFixed(1);
          document.getElementById('no2val').textContent = parseFloat(feed.field7).toFixed(3);
        }
      } catch (e) {
        console.error("ThingSpeak fetch failed:", e);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      showTab('co2', document.querySelector(".tablink"));
      fetchThingSpeakData();
      setInterval(fetchThingSpeakData, 30000);
    });
  </script>
</body>
</html>
