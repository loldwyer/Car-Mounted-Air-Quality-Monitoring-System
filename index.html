<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Car-Mounted Air Quality Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Car-Mounted Urban Air Quality Monitor</h1>
    <p>Live COâ‚‚, PM, and NOâ‚‚ data from ESP32 + Blynk + ThingSpeak</p>
  </header>

  <section>
    <h2>ğŸ“Š SCD30 Sensor Data (COâ‚‚, Temp, Humidity)</h2>
    <div class="tabs">
      <button class="tablink" onclick="showTab('co2', this)">COâ‚‚</button>
      <button class="tablink" onclick="showTab('temp', this)">Temperature</button>
      <button class="tablink" onclick="showTab('rh', this)">Humidity</button>
    </div>

    <div id="co2" class="tabcontent">
      <p><strong>Latest COâ‚‚:</strong> <span id="co2val">Loading...</span> ppm</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/4?dynamic=true"></iframe>
    </div>
    <div id="temp" class="tabcontent" style="display:none;">
      <p><strong>Latest Temperature:</strong> <span id="tempval">Loading...</span> Â°C</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/5?dynamic=true"></iframe>
    </div>
    <div id="rh" class="tabcontent" style="display:none;">
      <p><strong>Latest Humidity:</strong> <span id="humval">Loading...</span> %</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/6?dynamic=true"></iframe>
    </div>
  </section>

  <section>
    <h2>ğŸ“Š SPS30 Sensor Data (Particulate Matter)</h2>
    <div class="tabs">
      <button class="tablink" onclick="showTab('pm1', this)">PM1.0</button>
      <button class="tablink" onclick="showTab('pm25', this)">PM2.5</button>
      <button class="tablink" onclick="showTab('pm10', this)">PM10</button>
    </div>

    <div id="pm1" class="tabcontent">
      <p><strong>Latest PM1.0:</strong> <span id="pm1val">Loading...</span> Âµg/mÂ³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/1?dynamic=true"></iframe>
    </div>
    <div id="pm25" class="tabcontent" style="display:none;">
      <p><strong>Latest PM2.5:</strong> <span id="pm25val">Loading...</span> Âµg/mÂ³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/2?dynamic=true"></iframe>
    </div>
    <div id="pm10" class="tabcontent" style="display:none;">
      <p><strong>Latest PM10:</strong> <span id="pm10val">Loading...</span> Âµg/mÂ³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/3?dynamic=true"></iframe>
    </div>
  </section>

  <section>
    <h2>ğŸ“Š MiCS-4514 Sensor Data (NOâ‚‚)</h2>
    <p><strong>Latest NOâ‚‚ Voltage:</strong> <span id="no2val">Loading...</span> V</p>
    <iframe src="https://thingspeak.com/channels/2960675/charts/7?dynamic=true"></iframe>
  </section>

  <section>
    <h2>ğŸ“Š Blynk Dashboard Snapshot</h2>
    <img src="images/blynk-dashboard.png" alt="Blynk dashboard" />
    <p>Displays real-time control and alert widgets from the Blynk IoT app.</p>
  </section>

  <section>
    <h2>âš™ï¸ System Overview</h2>
    <img src="images/system-diagram.png" alt="System Diagram" />
    <ul>
      <li>ESP32 with Wi-Fi + SD Card logging</li>
      <li>SCD30 sensor for COâ‚‚, Temperature, and Humidity</li>
      <li>SPS30 sensor for PM1.0, PM2.5, PM10</li>
      <li>MiCS-4514 sensor for NOâ‚‚ levels</li>
      <li>Optional GPS and OLED for mobile display</li>
    </ul>
  </section>

  <section>
    <h2>ğŸ“ƒ Sample Log File</h2>
    <p><a href="data/latest.csv" download>Download Latest CSV Log</a></p>
  </section>

  <footer>
    <p>&copy; 2025 Lauren Dwyer | MEng ECE Project</p>
  </footer>

  <script>
    function showTab(id, el) {
      const contents = document.querySelectorAll('.tabcontent');
      contents.forEach(el => el.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      const buttons = document.querySelectorAll('.tablink');
      buttons.forEach(btn => btn.classList.remove('active'));
      if (el) el.classList.add('active');
    }

    async function fetchThingSpeakData() {
      try {
        const res = await fetch('https://api.thingspeak.com/channels/2960675/feeds.json?results=1');
        const data = await res.json();
        const feed = data.feeds[0];
        document.getElementById('co2val').textContent = parseFloat(feed.field4).toFixed(1);
        document.getElementById('tempval').textContent = parseFloat(feed.field5).toFixed(1);
        document.getElementById('humval').textContent = parseFloat(feed.field6).toFixed(1);
        document.getElementById('pm1val').textContent = parseFloat(feed.field1).toFixed(1);
        document.getElementById('pm25val').textContent = parseFloat(feed.field2).toFixed(1);
        document.getElementById('pm10val').textContent = parseFloat(feed.field3).toFixed(1);
        document.getElementById('no2val').textContent = parseFloat(feed.field7).toFixed(3);
      } catch (e) {
        console.error("ThingSpeak data fetch error:", e);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      showTab('co2', document.querySelector('.tablink'));
      fetchThingSpeakData();
      setInterval(fetchThingSpeakData, 30000);
    });
  </script>
</body>
</html>
